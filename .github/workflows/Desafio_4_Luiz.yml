name: Desafio 4 - Quality Gate

on: [push, pull_request]

jobs:
  test-and-verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # Passo 1: Executar testes e gerar relat√≥rio JaCoCo
      - name: Executar Testes com Maven
        run: mvn clean verify

      # Passo 2: Verificar Cobertura e Parsear Relat√≥rio
      # Aqui usamos 'awk' para ler o CSV gerado pelo JaCoCo.
      # O JaCoCo CSV tem colunas: INSTRUCTION_MISSED, INSTRUCTION_COVERED
      - name: Verificar Cobertura M√≠nima (80%)
        id: check_coverage
        run: |
          echo "Calculando cobertura..."

          # Caminho padr√£o do relat√≥rio CSV do JaCoCo
          REPORT_FILE=target/site/jacoco/jacoco.csv

          if [ ! -f "$REPORT_FILE" ]; then
            echo "Relat√≥rio de cobertura n√£o encontrado!"
            exit 1
          fi

          # Script AWK para somar instru√ß√µes cobertas e perdidas
          # Coluna 4 = Instru√ß√µes perdidas, Coluna 5 = Instru√ß√µes cobertas
          COVERAGE=$(awk -F, 'NR>1 {missed+=$4; covered+=$5} END {print (covered/(missed+covered))*100}' $REPORT_FILE)

          # Formatar para 2 casas decimais
          COVERAGE_FORMATTED=$(printf "%.2f" $COVERAGE)

          echo "Cobertura Atual: $COVERAGE_FORMATTED%"

          # Exportar vari√°vel para passos seguintes (opcional)
          echo "COVERAGE=$COVERAGE_FORMATTED" >> $GITHUB_ENV

          # L√≥gica de Falha (Compara√ß√£o de ponto flutuante via bc)
          if (( $(echo "$COVERAGE < 80.0" | bc -l) )); then
            echo "‚ùå FALHA: Cobertura abaixo de 80%!"
            exit 1
          else
            echo "‚úÖ SUCESSO: Meta de cobertura atingida."
          fi

      # Passo 3: Mensagem de Sucesso (Executa apenas se o anterior passou)
      - name: Notificar Sucesso
        if: success()
        run: |
          echo "üéâ Parab√©ns! O c√≥digo passou com ${{ env.COVERAGE }}% de cobertura."

      # Passo 4: Mensagem de Falha (Executa apenas se falhou)
      - name: Notificar Falha
        if: failure()
        run: |
          echo "üö´ Bloqueado! Melhore seus testes. Cobertura atual: ${{ env.COVERAGE }}% (M√≠nimo: 80%)"